---
title: "Michael Jordan BioComp Assignment"
author: "Michael Jordan"
date: "2023-12-01"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction & Rationale

The malleefowl (Leipoa ocellata) is a large (~2kg) ground-dwelling bird endemic to Australia. It is a member of the Megapodiidae family, which incubate their eggs in mounds that provide an external source of heat rather than in nests using body heat (Parsons, Short, and Roberts, 2008).  Within the Megapodiidae, the malleefowl is the only species to inhabit arid to semi-arid shrublands and low woodlands rather than damp forests (Benshemesh, 2007).

To facilitate incubation in these environments, malleefowl developed particularly complex mounds. Malleefowl mounds are large (~3-5m in diameter x 1m deep), scraped out of the ground, filled with leaf litter, and covered with sand, which acts as insulation (Benshemesh, 2007). Solar radiation and fermentation of organic matter maintain a temperature within ~3-5°C of 34°C, which is necessary for egg development (Booth, 1986).  Aside from sand and leaf litter, malleefowl habitat requirements are not otherwise well understood.  However, population concentration is observed to be highest in areas with higher rainfall and more fertile soil, likely due to increased food supply (Benshemesh, 2007).

Although the malleefowl was widely distributed across Australia prior to European colonization, its population declined significantly post colonization due to habitat loss and predation by introduced predators (Parsons, Short, and Roberts, 2008). Today, the malleefowl is listed as vulnerable on the IUCN Red List and under the Australian Environment Protection and Biodiversity Conservation Act of 1999.

In 2007, the Australian government instituted a five year $2.4M AUD malleefowl National Recovery Plan (Benshemesh, 2007). Although the report lacked sufficient evidence to assess malleefowl conservation status across Australia, it cited steep declines in monitored populations to justify action. The NRP set several objectives, including reducing habitat loss and reducing grazing pressure by livestock.

However, these initiatives are unlikely to succeed if climate change renders current malleefowl habitat nonviable. Prior research has indicated that reduction in rainfall and increase in temperature may be particularly significant, since they impact breeding activity (Stenhouse & Moseby, 2022).

This report aims to use a presence/absence logistic GLM to estimate the likely impact of climate change on malleefowl species distribution in order to inform malleefowl recovery.  If malleefowl habitat is expected to expand or contract, NRP objectives may need to be adjusted.  Additionally, it conducts statistical analysis on the Megapodiidae family to determine if dispersability relates to species extinction risk.


## Modelling Current and Future Malleefowl Species Distribution

Analysis was completed using R version 4.3.1.  Malleefowl occurrence data was downloaded from the Global Biodiversity Information Facility (GBIF, 2022) database using the Dismo package.

```{r import}
# Load necessary libraries
library(dismo)
library(terra)
library(geodata)
library(sf)
library(rnaturalearth)
library(dplyr)
library(bestglm)

# Import data from GBIF and retain only relevant columns.
m.full <- dismo::gbif("Leipoa", "ocellata") # n = 10494
keep <- c("adm1", "adm2", "basisOfRecord", "cloc", "collectionCode",
          "coordinateUncertaintyInMeters", "day", "eventDate", "eventTime",
          "gbifID", "geodeticDatum", "georeferenceVerificationStatus",
          "higherGeography", "identifiedBy", "informationWithheld",
          "institutionCode", "lat", "locality", "lon", "month", "occurrenceID",
          "occurrenceRemarks", "protocol", "recordedBy", "year")
m <- m.full[, names(m.full) %in% keep]
```

Data were cleaned to include only trustworthy, non-duplicate observations from years used as a historic baseline.  Geo coordinate uncertainty was tolerated up to 1km, since this provided reasonable precision relative to GIS data resolution (~3.5-4.5km, see below).  Data were checked for incorrect geo coordinate zeroing, but none was found.  Observations were plotted using the Terra and sf packages to validate.

```{r clean}
# Clean data: 1) filter for observation occurrences, 2) remove occurrences
# without geo coords, 3) remove uncertain occurrences (unverified, obfuscated
# geo coords, > 1km geo coord uncertainty), 3) filter for records in baseline
# historical years.
m <- m[
  m$basisOfRecord %in% c("HUMAN_OBSERVATION", "MACHINE_OBSERVATION")
  & !is.na(m$lon)
  & !is.na(m$lat)
  & (
    is.na(m$georeferenceVerificationStatus)
    | m$georeferenceVerificationStatus == "verified")
  & is.na(m$informationWithheld)
  & (
    is.na(m$coordinateUncertaintyInMeters)
    | m$coordinateUncertaintyInMeters <= 1000)
  & !is.na(m$year)
  & m$year >= 1970
  & m$year <= 2000, ] # n = 774

# Drop observations that are duplicative at the day/lat/lon level.  Visual spot
# check confirmed identical metadata for duplicate events at this level.
m$dup <- duplicated(m[, c("eventDate", "lon", "lat")])
m <- m[m$dup == FALSE, ] # n = 732

# Declare geo coords extent and plot observations.
ext <- terra::ext(110, 155, -45, -8)
m.sf <- sf::st_as_sf(m, coords = c("lon", "lat"), crs = 4326)
au <- rnaturalearth::ne_countries(
  country = "australia",
  scale = "large",
  returnclass = "sf")
plot(
  sf::st_geometry(au),
  xlim = ext[1:2],
  ylim = ext[3:4],
  bg = "lightblue",
  col = "ivory",
  axes = TRUE)
plot(sf::st_geometry(m.sf), add = TRUE, col = "blue", border = NA, pch = 2)
```
To estimate species distribution, historical (1970-2000) and future climate data were pulled from WorldClim 2.1 using the geodata package.  Future climate data was pulled for two sequential time periods (2021-2040, 2041-2060) using the Hadley GEM3 model and Shared Socioeconomic Pathway 2-4.5.

The future time periods were chosen in order to evaluate time scale of malleefowl distribution shift.  SSP 2-4.5 was chosen because it represents a "middle ground" scenario and so should provide a conservative estimate of malleefowl distribution changes.

The WorldClim data provided 19 climate measurements, many of which were similar or lacked a plausible biological mechanism to impact malleefowl distribution.  The following variables were chosen as potential model coefficients based on their being distinct and biologically relevant.

BIO1 = Annual Mean Temperature
BIO3 = Isothermality (BIO2/BIO7) (×100)
BIO5 = Max Temperature of Warmest Month
BIO6 = Min Temperature of Coldest Month
BIO12 = Annual Precipitation
BIO13 = Precipitation of Wettest Month
BIO14 = Precipitation of Driest Month

Because malleefowl are likely to have elevation and soil composition preferences (Benshemesh, 2007), the geodata package was used to pull elevation data from the Shuttle Radar Topography Mission and sand composition and carbon density (as a proxy for soil richness) data from the SoilGRIDS database. Sand composition was measured as the percentage of > .05mm particles in fine earth.  Organic carbon density was measured as kg per cubic meter.

Climate and elevation data were pulled at a 2.5 arc-minute resolution.  Soil data were pulled at a 30 arc-second resolution and aggregated to a 2.5 arc-minute resolution.  A 2.5 arc-minute resolution was chosen because it is reasonably fine and should encompass an individual malleefowl territory. At Australian latitudes (~ -10° to -40°), 2.5 arc-minutes is between ~ 3.5-4.5km. Radio-tracking demonstrates that malleefowl range from one to several miles within a year (Benshemesh, 2007).

```{r gather}
# Pull historical and future climate data as well as elevation and soil data.
# Crop to Australia geo extent.
bioclim.h <- geodata::worldclim_global(var = "bio", res = 2.5, path = "data")
bioclim.h <- terra::crop(bioclim.h, ext)
bioclim.f1 <- geodata::cmip6_world(
  model = "HadGEM3-GC31-LL",
  ssp = "585",
  time = "2021-2040",
  var = "bioc",
  path = "data",
  res = 2.5)
bioclim.f1 <- terra::crop(bioclim.f1, ext)
bioclim.f2 <- geodata::cmip6_world(
  model = "HadGEM3-GC31-LL",
  ssp = "585",
  time = "2041-2060",
  var = "bioc",
  path = "data",
  res = 2.5)
bioclim.f2 <- terra::crop(bioclim.f2, ext)
elev <- geodata::elevation_global(res = 2.5, path = "data")
elev <- terra::crop(elev, ext)
sand <- geodata::soil_world(
  var = "sand",
  stat = "mean",
  depth = 60,
  path = "data")
sand <- terra::crop(sand, ext)
carbon <- geodata::soil_world(
  var = "ocd",
  stat = "mean",
  depth = 60,
  path = "data")
carbon <- terra::crop(carbon, ext)

# Aggregate soil rasters from 30 arc-second 2.5 arc-minute resolution.
sand <- terra::aggregate(sand, fact = 5, fun = mean)
carbon <- terra::aggregate(carbon, fact = 5, fun = mean)

# Align and simplify column names.
bioclim.names <- paste0("bio", 1:19)
names(bioclim.h) <- bioclim.names
names(bioclim.f1) <- bioclim.names
names(bioclim.f2) <- bioclim.names
names(elev) <- c("elev")
names(sand) <- c("sand")
names(carbon) <- c("ocd")

# Select subset of variables relevant to test in a model.
bioclim.h <- terra::subset(
  bioclim.h,
  c("bio1", "bio3", "bio5", "bio6", "bio12", "bio13", "bio14"))
bioclim.f1 <- terra::subset(
  bioclim.f1,
  c("bio1", "bio3", "bio5", "bio6", "bio12", "bio13", "bio14"))
bioclim.f2 <- terra::subset(
  bioclim.f2,
  c("bio1", "bio3", "bio5", "bio6", "bio12", "bio13", "bio14"))
```

The Australia Albers projection was chosen since it is an equal area projection, enabling accurate area comparisons across latitudes.

Climate, elevation, and soil rasters were projected onto it and combined.

```{r project}
# Create a grid and project objects onto the Australian Albers projection.
ntm.grid <- terra::rast(
  ext(-2740000, 2400000, -5252000, -944000), 
  res = 20000,
  crs = "EPSG:3577")
m.sf <- sf::st_transform(m.sf, crs = "EPSG:3577")
bioclim.h <- terra::project(bioclim.h, ntm.grid)
bioclim.f1 <- terra::project(bioclim.f1, ntm.grid)
bioclim.f2 <- terra::project(bioclim.f2, ntm.grid)
elev <- terra::project(elev, ntm.grid)
sand <- terra::project(sand, ntm.grid)
carbon <- terra::project(carbon, ntm.grid)

# Add elevation, sand, and carbon data to historical and future rasters.
bioclim.h <- c(bioclim.h, elev, sand, carbon)
bioclim.f1 <- c(bioclim.f1, elev, sand, carbon)
bioclim.f2 <- c(bioclim.f2, elev, sand, carbon)

# Use au vector from rnaturalearth to mask non-AU islands.
au.msk <- sf::st_transform(au, crs = "EPSG:3577")
bioclim.h <- terra::mask(bioclim.h, au.msk["type"])
bioclim.f1 <- terra::mask(bioclim.f1, au.msk["type"])
bioclim.f2 <- terra::mask(bioclim.f2, au.msk["type"])
```

Since logistic regression requires both presence and absence data points, a number of background psuedo-absence points equal to the observation count (n = 732) were generated at random using the Dismo package.

One potential problem with this approach is that malleefowl are rare, elusive, and not exhaustively surveyed. As a result, there is an elevated likelihood that psuedo-absence points may diverge from true absence (i.e., contain malleefowl). If this is the case, any model will be biased.

```{r absence}
# Create random psuedo absence geo coords.
n.pseudo <- nrow(m.sf)
land <- bioclim.h[["elev"]] > 0
pseudo.dismo <- dismo::randomPoints(
  mask = as(land, "Raster"),
  n = n.pseudo, 
  p = sf::st_coordinates(m.sf))
pseudo.dismo <- sf::st_as_sf(
  data.frame(pseudo.dismo),
  coords = c("x", "y"),
  crs = 3577)

# Plot presence and psuedo-absence points to visually inspect for errors.
# TODO: Add mask for non-AU
terra::plot(land, col = "grey", legend = FALSE)
terra::plot(sf::st_geometry(m.sf), add = TRUE, col = "blue", cex = 1, pch = 2)
terra::plot(pseudo.dismo, add = TRUE, col = "black", cex = .1, pch = 19)
```

To reserve 20% of data for model evaluation, the Dismo package was used to add quintiles. Data were combined into a single presence/absence raster for model fitting.

```{r combine}
# Subdivide presence/absence for training/testing.
m.sf$kfold <- dismo::kfold(m.sf, k = 5)
pseudo.dismo$kfold <- dismo::kfold(pseudo.dismo, k = 5)

# Create presence/absence binomial dataset and add environmental data.
present <- terra::subset(m.sf, select = "kfold")
present$pa <- 1
absent <- pseudo.dismo
absent$pa <- 0
names(absent) <- c("geometry", "kfold", "pa")
sf::st_geometry(absent) <- "geometry"
pa.data <- rbind(present, absent)
envt.data <- terra::extract(bioclim.h, pa.data, ID = FALSE)
pa.data <- cbind(pa.data, envt.data)
```

In total, ten coefficients were considered for a logistic GLM. The bestglm package was used to assess the most parsimonious model per Aikake Information Criteria.  AIC balances a trade-off between the likelihood that a model could have produced the observations and the number of coefficients in the model.  I.e., it wants the most explanatory power for the least coefficients.

```{r aic}
# Subset presence/absence data and run bestglm to select best model per AIC.
fit <- as.data.frame(pa.data)
fit <- fit[, !(names(fit) %in% c("geometry", "kfold"))]
fit <- relocate(fit, pa, .after = last_col())
best.fit <- bestglm(fit, IC = "AIC", family = binomial(link = "logit"))
best.fit
best.fit$Subsets
```

Model nine, which includes all variables except for Bio3, had the lowest AIC score. 

Comparing model ten (another model with a low AIC score) to model 9, model ten had lower residual deviance (485.85 vs 485.89), a measure of model fit.

```{r aic_explain}
# Fit models 9 and 10
m.9 <- glm(
  pa ~ bio1 + bio5 + bio6 + bio12 + bio13 + bio14 + elev + sand + ocd,
  data = pa.data, 
  family = binomial(link = "logit"),
  subset = kfold != 1)

m.10 <- glm(
  pa ~ bio1 + bio3 + bio5 + bio6 + bio12 + bio13 + bio14 + elev + sand + ocd,
  data = pa.data, 
  family = binomial(link = "logit"),
  subset = kfold != 1)

# Extract deviance
m.9$deviance
m.10$deviance
```
But, the difference was very minor and model ten included an additional coefficient.  AIC reasonably picked model nine as the most parsimonious model.

Model nine was fit and the results plotted.

```{r fitting}
# Fit the GLM.
glm.model <- glm(
  pa ~ bio1 + bio5 + bio6 + bio12 + bio13 + bio14 + elev + sand + ocd,
  data = pa.data, 
  family = binomial(link = "logit"),
  subset = kfold != 1)

# Summarize and plots model results
summary(glm.model)
par(mar = c(3, 3, 1, 1), mgp = c(2, 1, 0))
dismo::response(
  glm.model,
  fun = function(x, y, ...) predict(x, y, type = "response", ...))
```
The model results showed that all coefficients were statistically significant except for Bio14 (Precipitation of Driest Month).

Examining response graphs, the direction of relationships mostly makes biological sense. As expected, probability of presence increases with Bio13 (Precipitation of Wettest Month), sand soil composition, and elevation (malleefowl are known to live in low lying areas).  

Other relationships are less intuitive, but make sense in the context of known habitat. For example, it may seem odd that probability of presence decreases with Bio12  (Annual Precipitation) and carbon density of soil.  But, this probably reflects a preference against damp forests.

Temperature results were slightly more confusing. Probability of presence increases with Bio5 (Max Temperature of Warmest Month). But, it decreases with Bio1 (Annual Mean Temperature) and Bio6 (Min Temperature of Coldest Month).  Why different directions of effect for temperature?  More analysis is needed, but it's not unreasonable to expect that malleefowl may have different reactions to different ends of the temperature range.

Next, the model was fit on historical data and an ROC curve was plotted.

```{r roc}
# Create a prediction layer and evaluate the results.
glm.pred <- terra::predict(bioclim.h, glm.model, type = "response")
test.present <- sf::st_coordinates(subset(pa.data, pa == 1 & kfold == 1))
test.absent <- sf::st_coordinates(subset(pa.data, pa == 0 & kfold == 1))
glm.eval <- dismo::evaluate(
  p = test.present,
  a = test.absent,
  model = glm.model,
  x = bioclim.h)
print(glm.eval)

# Plot ROC curve
plot(glm.eval, "ROC", type = "l")
```

The area under the ROC curve was .96, indicating little trade-off between sensitivity and specificity across threshold of presence.

Because there was so little trade-off between specificity and sensitivity, the threshold at which the sum of specificity and sensitivity were maximized was chosen to determine presence in the model.

```{r threshold}
# Extract threshold that maximizes specifity plus sensitivity
spec.sense <- plogis(threshold(glm.eval, stat = "spec_sens"))
print(spec.sense)
```
Finally, estimated current distributed was plotted along with future distribution for 2021-2040 and 2041-2060.

```{r final}
# Plot species distribution maps 
par(mfrow = c(2, 2))
glm.map <- glm.pred >= spec.sense
plot(glm.map, legend = FALSE, col = c("grey", "blue"))

glm.pred.future1 <- predict(bioclim.f1, glm.model, type = "response")
glm.map.future1 <- glm.pred.future1 >= spec.sense
plot(glm.map.future1, legend = FALSE, col = c("grey", "blue"))

glm.pred.future2 <- predict(bioclim.f2, glm.model, type = "response")
glm.map.future2 <- glm.pred.future2 >= spec.sense
plot(glm.map.future2, legend = FALSE, col = c("grey", "blue"))

# Plot overlaid species distribution maps.
plot(glm.map, legend = FALSE, col = c("grey", "blue"))
f1.msk <- ifel(glm.pred.future1 < spec.sense, NA, 1)
f1m <- terra::mask(glm.map.future1, f1.msk)
glm.map.future1.p <- terra::mask(f1m, f1m)
plot(glm.map.future1.p, legend = FALSE, add = TRUE, col = "green")
f2.msk <- ifel(glm.pred.future2 < spec.sense, NA, 1)
f2m <- terra::mask(glm.map.future2, f2.msk)
glm.map.future2.p <- terra::mask(f2m, f2m)
plot(glm.map.future2.p, legend = FALSE, add = TRUE, col = c("yellow"))
```

Results suggested that malleefowl range will contract significantly in 2021-2040 and even more significantly in 2040-2060.

```{r results}
# Table of shift from 1970-2000 to 2021-2040
h.f1 <- arrange(
  data.frame(
    table(values(glm.map), values(glm.map.future1))),
  Var1,
  Var2)
colnames(h.f1) <- c("Hist", "F1", "Freq")

# Table of shift from 1970-2000 to 2041-2060
h.f2 <- arrange(
  data.frame(
    table(values(glm.map), values(glm.map.future2))),
  Var1,
  Var2)
colnames(h.f2) <- c("Hist", "F2", "Freq")

# Calculate shift from 1970-2000 to 2021-2040 
sum(h.f1[h.f1$F1 == "TRUE", ]$Freq) / sum(h.f1[h.f1$Hist == "TRUE", ]$Freq)

# Calculate shift from 1970-2000 to 2041-2060
sum(h.f2[h.f2$F2 == "TRUE", ]$Freq) / sum(h.f2[h.f2$Hist == "TRUE", ]$Freq)
```
Specifically, malleefowl habitat is expected to decline to 41% of its historical range by 2021-2040 and to 10% by 2041-2060.

In particular, Western Australia is forecast to be uninhabitable by malleefowl between 2040 and 2060.  The last significant viable habitat is expected to be in western New South Wales.

This suggests that focusing malleefowl conservation efforts in NSW and abandoning efforts in WA would be the most prudent course of action if conservation dollars are limited.


## Statistical Analysis of Megapodiidae Extinction Risk vs Hand-Wing Index

The above analysis provided recommendations to guide Australian malleefowl conservation.  But, among all Megapodiidae, should the malleefowl be prioritized by global conservationists?  If so, what factors give rise to malleefowl vulnerability?  Perhaps wing size?

EDGE score and Hand-Wing Index can be used to evaluate these questions. EDGE (Evolutionary Distinct Globally Endangered) scores measure species' evolutionary uniqueness along with their extinction risk.  Hand-Wing Index measures [WHATEVER IT MEASURES.]

Imperial College provided data on 30 individuals across 10 Megapodiidae species.  This data was cleaned and average Hand-Wing Index across individuals was taken per species. 

```{r stats_setup}
# Set working directory
setwd("C:/Users/Michael Jordan/Desktop/R/BioCompAssessment")

# Pull in data, filter for Megapodiidae, and arrange by EDGE score.
b.full <- read.csv("birds_edge_trait.csv", header = TRUE)
b <- b.full[b.full$Family == "MEGAPODIIDAE", c(2,5:7)]

# Aggregate by species and average across trait measurements.
b.agg <- dplyr::arrange(
  dplyr::summarise(
    group_by(b, Species, Common.name, EDGE),
    .groups = "keep",
    avg.HWI = mean(Hand.wing.Index)),
  desc(EDGE))

# Output results
b.agg
```

The malleefowl has a high EDGE score (although not the highest!) and there may be some relationship between HWI and EDGE score.  It seems like species with higher HWI might have  higher EDGE scores.

To evaluate, a linear model of HWI on EDGE score was fit.

```{r stats_model}
# Fit linear model
m.b <- lm(EDGE ~ avg.HWI, data = b.agg)

# Summarise
summary(m.b)
```

The model shows that HWI is not a statistically significant predictor vs an alpha of 5%.  The p-value is very high at .46.

But, is this a good model?  R-squared is 7%, showing that the model explains only a very small percentage of the variance in the data. Is linear regression even appropriate in this case?

```{r stats_plot}
# Plot linear model
par(mfrow = c(2,2))
plot(m.b)

# Plot histogram of residuals
hist(m.b$residuals)
```

It's difficult to tell because degrees of freedom are low.  But, there seem to be two issues.

Examining the plot of residuals vs fitted values shows significant heteroskedasticity.  Variance is much higher on the low end of the distribution than on the high end.  This will result HWI being a biased estimator.

Examining the Q-Q plot of z-transformed residuals vs theoretical quantiles of the z distribution, the residuals don't look normally distributed.  If they were normal, they would align along the straight line.  Instead, they curve off it at the high and low ends of the distribution.  Looking at a histogram of residuals confirms it, they have a strong right skew.

In fact, there is a worse problem:  the data clearly aren't independent!  These aren't random observations from a pool of hypothetical Megapodiidae species.  They're evoluationarily related species. 

## Summary


## Citations

Benshemesh, J. (2007). National Recovery Plan for Malleefowl. Department for Environment and Heritage, South Australia

Blair C. ParsonsA,B,D, Jeff C. ShortC and J. Dale RobertsB (2008).  Contraction in the range of Malleefowl (Leipoa ocellata) in Western Australia: a comparative assessment using presence-only and presence–absence datasets

Booth 1986, Effect of Temperature on Development of Mallee Fowl Leipoa ocellata Eggs

Peri Stenhouse a and Katherine Moseby b, 2022 Trends in breeding activity of the threatened Malleefowl (Leipoa ocellata): what can we expect under a changing climate?



(Blakers et al. 1984)

Priddel & Wheeler 2003

Copley & Williams 1995)

Hill 1989

Brickhill 1987b  #unseasonable weather hurting egg incubation