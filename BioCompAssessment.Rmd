---
title: "Michael Jordan BioComp Assignment"
author: "Michael Jordan"
date: "2023-12-01"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction & Rationale

The malleefowl (Leipoa ocellata) is a large (~2kg) ground-dwelling bird endemic to Australia. It is a member of the Megapodiidae family, which incubate their eggs in mounds that provide an external source of heat rather than in nests using body heat.  Within the Megapodiidae, the malleefowl is the only species to inhabit arid to semi-arid shrublands and low woodlands rather than damp forests.

To facilitate incubation in these environments, malleefowl developed particularly complex mounds. Malleefowl mounds are large (~ 2 ft x 3 ft), scraped out of the ground, filled with leaf litter, and covered with sand, which acts as insulation. Solar radiation and fermentation of organic matter maintain a constant temperature of 33°C within mounds, which is necessary for egg development.  Aside from sand and leaf litter, malleefowl habitat requirements are not otherwise well understood.  However, population concentration is observed to be highest in areas with higher rainfall and more fertile soil, likely due to increased food supply (Copley & Williams 1995).

Although the malleefowl was widely distributed across Australia prior to European colonization (Hill 1989), its population declined significantly post colonization, primarily from habitat loss due to wheat and sheep production. Today, the malleefowl is listed as vulnerable on the IUCN Red List and under the Australian Environment Protection and Biodiversity Conservation Act of 1999.

In 2007, the Australian government instituted a five year $2.4M AUD National Recovery Plan for the malleefowl (Benshemesh, 2007). Although the report lacked sufficient evidence to assess malleefowl conservation status across Australia, it cited steep declines in monitored populations to justify action (Priddel & Wheeler 2003). The NRP set several objectives, including reducing habitat loss and reducing grazing pressure by livestock.

However, these initiatives are unlikely to be successful if climate change renders current malleefowl habitat nonviable. Changes to rainfall and temperature may be particularly significant, since they could impact breeding success (e.g., if mound temperature falls below 33°C or the environment stops producing sufficient leaf litter for mound construction).

This report aims to use a presence/absence logistic GLM to estimate the likely impact of climate change on malleefowl species distribution in order to inform malleefowl recovery.  If malleefowl habitat is expected to expand or contract, NRP objectives may need to be adjusted.  Additionally, it conducts statistical analysis on the Megapodiidae family to determine if hand-wing index relates to species extinction risk.


## Modelling Current and Future Malleefowl Species Distribution

All analysis was completed using R version 4.3.1.  Malleefowl occurrence data was downloaded from the Global Biodiversity Information Facility (GBIF) database using the Dismo package.

```{r import}
# Load necessary libraries
library(dismo)
library(terra)
library(geodata)
library(sf)
library(rnaturalearth)
library(dplyr)
library(bestglm)

# Import data from GBIF and retain only relevant columns.
m.full <- dismo::gbif("Leipoa", "ocellata") # n = 10490
keep <- c("adm1", "adm2", "basisOfRecord", "cloc", "collectionCode",
          "coordinateUncertaintyInMeters", "day", "eventDate", "eventTime",
          "gbifID", "geodeticDatum", "georeferenceVerificationStatus",
          "higherGeography", "identifiedBy", "informationWithheld",
          "institutionCode", "lat", "locality", "lon", "month", "occurrenceID",
          "occurrenceRemarks", "protocol", "recordedBy", "year")
m <- m.full[, names(m.full) %in% keep]
```

Data was cleaned to include only trustworthy, non-duplicate observations from the years covered by our historical climate data (1970 - 2000).  Geo coordinate uncertainty was tolerated up to 1km, since this provided reasonable precision relative to the resolution of our GIS data (2.5 arc-minutes, ~1.3km at Australian longitudes [UPDATE RATIONALE]).  Data were checked for incorrect geo coordinate zeroing, but none was found.  Observations were plotted using the Terra and sf packages to validate.

```{r clean}
# Clean data: 1) filter for observation occurrences, 2) remove occurrences
# without geo coords, 3) remove uncertain occurrences (unverified, obfuscated
# geo coords, > 1km geo coord uncertainty), 3) filter for records in baseline
# historical years.
m <- m[
  m$basisOfRecord %in% c("HUMAN_OBSERVATION", "MACHINE_OBSERVATION")
  & !is.na(m$lon)
  & !is.na(m$lat)
  & (
    is.na(m$georeferenceVerificationStatus)
    | m$georeferenceVerificationStatus == "verified")
  & is.na(m$informationWithheld)
  & (
    is.na(m$coordinateUncertaintyInMeters)
    | m$coordinateUncertaintyInMeters <= 1000)
  & !is.na(m$year)
  & m$year >= 1970
  & m$year <= 2000, ] # n = 774

# Drop observations that are duplicative at the day/lat/lon level.  Visual spot
# check confirmed identical metadata for duplicate events at this level.
m$dup <- duplicated(m[, c("eventDate", "lon", "lat")])
m <- m[m$dup == FALSE, ] # n = 731

# Declare geo coords extent and plot observations.
ext <- terra::ext(110, 155, -45, -8)
m.sf <- sf::st_as_sf(m, coords = c("lon", "lat"), crs = 4326)
au <- rnaturalearth::ne_countries(
  country = "australia",
  scale = "large",
  returnclass = "sf")
plot(
  sf::st_geometry(au),
  xlim = ext[1:2],
  ylim = ext[3:4],
  bg = "lightblue",
  col = "ivory",
  axes = TRUE)
plot(sf::st_geometry(m.sf), add = TRUE, col = "black", border = NA, pch = 2)
```

To estimate species distribution, historical (1970 - 2000) and future climate data were pulled from WorldClim 2.1 using the geodata package.  Future climate data was pulled for two sequential time periods (2021 - 2040, 2041 - 2060) using the Hadley GEM3 model and Shared Socioeconomic Pathway 2-4.5.

The two time periods were chosen in order to evaluate time scale of malleefowl distribution shift.  SSP 2-4.5 was chosen because it represents a "middle ground" scenario and so should provide a conservative estimate of the extent of malleefowl distribution changes (i.e., if a more extreme SSP occurs, a more extreme distribution change would be expected).

The WorldClim data provided 19 climate measurements, many of which were conceptually similar or lacked a plausible biological mechanism by which they might impact malleefowl distribution.  The following variables were chosen for consideration as a model coefficient based on their being distinct and plausibly biologically relevant.

BIO1 = Annual Mean Temperature
BIO3 = Isothermality (BIO2/BIO7) (×100)
BIO5 = Max Temperature of Warmest Month
BIO6 = Min Temperature of Coldest Month
BIO12 = Annual Precipitation
BIO13 = Precipitation of Wettest Month
BIO14 = Precipitation of Driest Month

Because malleefowl are likely to have prefernces for elevation, sandy soil, and fertile soil, the geodata package was used to pull elevation data from the Shuttle Radar Topography Mission and sand composition and carbon density (as a proxy for soil richness) data from the SoilGRIDS database.  Sand composition was measured as the percentage of > .05mm particles in fine earth.  Organic carbon density was measured as kg per cubic meter.

Climate and elevation data were pulled at a 2.5 arc-minute resolution (~1.3km at
Australian latitude).  Soil data were pulled at a 30 arc-second resolution and
aggregated to a 2.5 arc-minute resolution.

```{r gather}
# Pull historical and future climate data as well as elevation and soil data.
# Crop to Australia geo extent.
bioclim.h <- geodata::worldclim_global(var = "bio", res = 2.5, path = "data")
bioclim.h <- terra::crop(bioclim.h, ext)
bioclim.f1 <- geodata::cmip6_world(
  model = "HadGEM3-GC31-LL",
  ssp = "585",
  time = "2021-2040",
  var = "bioc",
  path = "data",
  res = 2.5)
bioclim.f1 <- terra::crop(bioclim.f1, ext)
bioclim.f2 <- geodata::cmip6_world(
  model = "HadGEM3-GC31-LL",
  ssp = "585",
  time = "2041-2060",
  var = "bioc",
  path = "data",
  res = 2.5)
bioclim.f2 <- terra::crop(bioclim.f2, ext)
elev <- geodata::elevation_global(res = 2.5, path = "data")
elev <- terra::crop(elev, ext)
sand <- geodata::soil_world(
  var = "sand",
  stat = "mean",
  depth = 60,
  path = "data")
sand <- terra::crop(sand, ext)
carbon <- geodata::soil_world(
  var = "ocd",
  stat = "mean",
  depth = 60,
  path = "data")
carbon <- terra::crop(carbon, ext)

# Aggregate soil rasters from 30 arc-second 2.5 arc-minute resolution.
sand <- terra::aggregate(sand, fact = 5, fun = mean)
carbon <- terra::aggregate(carbon, fact = 5, fun = mean)

# Align and simplify column names.
bioclim.names <- paste0("bio", 1:19)
names(bioclim.h) <- bioclim.names
names(bioclim.f1) <- bioclim.names
names(bioclim.f2) <- bioclim.names
names(elev) <- c("elev")
names(sand) <- c("sand")
names(carbon) <- c("ocd")

# Select subset of variables relevant to test in a model.
bioclim.h <- terra::subset(
  bioclim.h,
  c("bio1", "bio3", "bio5", "bio6", "bio12", "bio13", "bio14"))
bioclim.f1 <- terra::subset(
  bioclim.f1,
  c("bio1", "bio3", "bio5", "bio6", "bio12", "bio13", "bio14"))
bioclim.f2 <- terra::subset(
  bioclim.f2,
  c("bio1", "bio3", "bio5", "bio6", "bio12", "bio13", "bio14"))
```

The Geoscience Australia Lambert projection was chosen due to [ADD RATIONALE]. Climate, elevation, and soil rasters were projected onto it and elevation and soil rasters were added to climate rasters.

```{r project}
# Create a grid and project objects into the Geoscience Australia Lambert
#projection.
ntm.grid <- terra::rast(
  ext(-2740000, 2400000, -5252000, -944000), 
  res = 20000,
  crs = "EPSG:3112")
m.sf <- sf::st_transform(m.sf, crs = "EPSG:3112")
bioclim.h <- terra::project(bioclim.h, ntm.grid)
bioclim.f1 <- terra::project(bioclim.f1, ntm.grid)
bioclim.f2 <- terra::project(bioclim.f2, ntm.grid)
elev <- terra::project(elev, ntm.grid)
sand <- terra::project(sand, ntm.grid)
carbon <- terra::project(carbon, ntm.grid)

# Add elevation, sand, and carbon data to historical and future rasters.
bioclim.h <- c(bioclim.h, elev, sand, carbon)
bioclim.f1 <- c(bioclim.f1, elev, sand, carbon)
bioclim.f2 <- c(bioclim.f2, elev, sand, carbon)
```

Logistic regression requires both presence and absence data points.  So, a number of background psuedo-absence points equal to the observation count (n = 731) were generated at random using the Dismo package.

One potential problem with this approach is that models generated using psuedo-absence data will be less accurate the further the psuedo-absent data points diverge from true absence. Because malleefowl are rare, elusive, and not exhaustively surveyed, there is a meaningful risk that pseudo-absence points will include points where malleefowl are present, but not observed.  This will bias the model.  But, it cannot be adjusted for, just noted as a caveat.

```{r absence}
# Create random psuedo absence geo coords.
n.pseudo <- nrow(m.sf)
land <- bioclim.h[["elev"]] > 0
pseudo.dismo <- dismo::randomPoints(
  mask = as(land, "Raster"),
  n = n.pseudo, 
  p = sf::st_coordinates(m.sf))
pseudo.dismo <- sf::st_as_sf(
  data.frame(pseudo.dismo),
  coords = c("x", "y"),
  crs = 3112)

# Plot presence and psuedo-absence points to visually inspect for errors.
# TODO: Add mask for non-AU
terra::plot(land, col = "grey", legend = FALSE)
terra::plot(sf::st_geometry(m.sf), add = TRUE, col = "blue", cex = 1, pch = 2)
terra::plot(pseudo.dismo, add = TRUE, col = "black", cex = .1, pch = 19)
```

To reserve 20% of data for model evaluation, the Dismo package was used to add quintiles. Data were combined into a single binomial presence/absence raster for data fitting.

```{r combine}
# Subdivide presence/absence for training/testing.
m.sf$kfold <- dismo::kfold(m.sf, k = 5)
pseudo.dismo$kfold <- dismo::kfold(pseudo.dismo, k = 5)

# Create presence/absence binomial dataset and add environmental data.
present <- terra::subset(m.sf, select = "kfold")
present$pa <- 1
absent <- pseudo.dismo
absent$pa <- 0
names(absent) <- c("geometry", "kfold", "pa")
sf::st_geometry(absent) <- "geometry"
pa.data <- rbind(present, absent)
envt.data <- terra::extract(bioclim.h, pa.data)
pa.data <- cbind(pa.data, envt.data)
```

Including climate, elevation, and soil variables, ten coefficients were considered for inclusion in a logistic GLM. The bestglm package was used to assess the most parsimonious model per Aikake Information Criteria.  AIC balances a trade-off between the log-likelihood of the model (i.e., the likelihood the model could have produced the observations) and the number of coefficients in the model (i.e., it wants the most explanatory power for the least coefficients).

```{r aic}
# Subset presence/absence data and run bestglm to select best model per AIC.
fit <- as.data.frame(pa.data)
fit <- fit[, !(names(fit) %in% c("geometry", "kfold"))]
fit <- relocate(fit, pa, .after = last_col())
best.fit <- bestglm(fit, IC = "AIC", family = binomial(link = "logit"))
best.fit
best.fit$Subsets
```

Model nine, which includes all variables except for Bio3, had the lowest AIC score (681). 

Comparing model ten (another model with a low AIC score) to model 9, model ten had a lower residual deviance (560.85 vs 561.1).

```{r aic_explain}
# Fit models 9 and 10
m.9 <- glm(
  pa ~ bio1 + bio5 + bio6 + bio12 + bio13 + bio14 + elev + sand + ocd,
  data = pa.data, 
  family = binomial(link = "logit"),
  subset = kfold != 1)

m.10 <- glm(
  pa ~ bio1 + bio3 + bio5 + bio6 + bio12 + bio13 + bio14 + elev + sand + ocd,
  data = pa.data, 
  family = binomial(link = "logit"),
  subset = kfold != 1)

# Extract deviance
m.9$deviance
m.10$deviance
```

But, the difference was very minor and model ten included an additional coefficient.  AIC reasonably picked model nine as the most parsimonious model.

Model nine was fit and results plotted for evaluation.

```{r fitting}
# Fit the GLM.
glm.model <- glm(
  pa ~ bio1 + bio5 + bio6 + bio12 + bio13 + bio14 + elev + sand + ocd,
  data = pa.data, 
  family = binomial(link = "logit"),
  subset = kfold != 1)

# Summarize and plots model results
summary(glm.model)
par(mar = c(3, 3, 1, 1), mgp = c(2, 1, 0))
dismo::response(
  glm.model,
  fun = function(x, y, ...) predict(x, y, type = "response", ...))
```

The model results show that all coefficients were statistically significant, except for Bio6 (Min Temperature Of The Coldest Month).

Examining response graphs, the direction of relationships makes biological sense. Probability of presence increases with Bio5 (Max Temperature of Warmest Month), Bio13 (Precipitation of Wettest Month), Bio14 (Precipitation of Driest Month), and sand soil composition.  Probability of presence decreases with Bio1 (Annual Mean Temperature) and elevation.  Perhaps oddly, probability of presence decreases with Bio12  (Annual Precipitation) and carbon density of soil.  But, this may simply reflect a preference for against damp forest habitats.

Next, the model was fit on historical data and ROC curves were plotted.

```{r roc}
# Create a prediction layer and evaluate the results.
glm.pred <- terra::predict(bioclim.h, glm.model, type = "response")
test.present <- sf::st_coordinates(subset(pa.data, pa == 1 & kfold == 1))
test.absent <- sf::st_coordinates(subset(pa.data, pa == 0 & kfold == 1))
glm.eval <- dismo::evaluate(
  p = test.present,
  a = test.absent,
  model = glm.model,
  x = bioclim.h)
print(glm.eval)

# Plot ROC curves and kappa.
max.kappa <- plogis(threshold(glm.eval, stat = "kappa"))
par(mfrow = c(1, 2))
plot(glm.eval, "ROC", type = "l")
plot(glm.eval, "kappa", type = "l")
abline(v = max.kappa, lty = 2, col = "blue")
```

The area under the ROC curve was .977, indicating little trade-off between sensitivity and specificity across threshold of presence.

TODO:  Consider using an approach aside from kappa

To maximize overall model fit across sensitivity and specificity, the maximum Cohen's Kappa was used to set a threshold for model prediction.  Finally, estimated current distributed was plotted along with future distribution for 2021 - 2040 and 2041 - 2060.

```{r final}
# Plot species distribution maps
# TODO: Mask non-australia islands 
par(mfrow = c(2, 2))
glm.map <- glm.pred >= max.kappa
plot(glm.map, legend = FALSE, col = c("grey", "blue"))

glm.pred.future1 <- predict(bioclim.f1, glm.model, type = "response")
glm.map.future1 <- glm.pred.future1 >= max.kappa
plot(glm.map.future1, legend = FALSE, col = c("grey", "blue"))

glm.pred.future2 <- predict(bioclim.f2, glm.model, type = "response")
glm.map.future2 <- glm.pred.future2 >= max.kappa
plot(glm.map.future2, legend = FALSE, col = c("grey", "blue"))

# Plot overlaid species distribution maps.
plot(glm.map, legend = FALSE, col = c("grey", "blue"))
f1.msk <- ifel(glm.pred.future1 < max.kappa, NA, 1)
f1m <- mask(glm.map.future1, f1.msk)
glm.map.future1 <- mask(f1m, f1m)
plot(glm.map.future1, legend = FALSE, add = TRUE, col = "lightblue")
f2.msk <- ifel(glm.pred.future2 < max.kappa, NA, 1)
f2m <- mask(glm.map.future2, f2.msk)
glm.map.future2 <- mask(f2m, f2m)
plot(glm.map.future2, legend = FALSE, add = TRUE, col = c("lightblue1"))
```

Results suggest that malleefowl range is expected to contract significantly in 2021 - 2040 and even more significantly in 2040 - 2060.  

```{r results}
# Table of shift from 1970 - 2000 to 2021 - 2040
h.f1 <- arrange(
  data.frame(
    table(values(glm.map), values(glm.map.future1))),
  Var1,
  Var2)
colnames(h.f1) <- c("Hist", "F1", "Freq")

# Table of shift from 1970 - 2000 to 2041 - 2060
h.f2 <- arrange(
  data.frame(
    table(values(glm.map), values(glm.map.future2))),
  Var1,
  Var2)
colnames(h.f2) <- c("Hist", "F2", "Freq")

# TODO:  Find a way to extract results from rasters directly.
# Calculate shift from 1970 - 2000 to 2021 - 2040 
(8 + 646) / (737 + 646)

# Calculate shift from 1970 - 2000 to 2041 - 2060
(20 + 204) / (1179 + 204)
```

Overall, malleefowl habitat is expected to decline by 47% by 2021 - 2040 and by 16% by 2041 - 2060.

In particular, southwest Australia is forecast to be uninhabitable by malleefowl between 2040 and 2060.  The last significant patch of viable habitat is expected to be [WHEREVER THAT IS].

This suggests that focusing malleefowl conservation efforts in [WHEREVER THAT IS] would be the most efficient use of scarce conservation funding.


## Statistical Analysis of Megapodiidae Extinction Risk vs Hand-Wing Index

The above analysis provided recommendations to guide Australian malleefowl conservation.  But, among all Megapodiidae, should the malleefowl be prioritized by global conservationists?  If so, what factors give rise to malleefowl vulnerability?  Perhaps wing size?

EDGE score and Hand-Wing Index can be used to evaluate these questions. EDGE (Evolutionary Distinct Globally Endangered) scores measure species' evolutionary uniqueness along with their extinction risk.  Hand-Wing Index measures [WHATEVER IT MEASURES.]

Imperial College provided data on 30 individuals across 10 Megapodiidae species.  This data was cleaned and average Hand-Wing Index across individuals was taken per species. 

```{r stats_setup}
# Set working directory
setwd("C:/Users/Michael Jordan/Desktop/R/BioCompAssessment")

# Pull in data, filter for Megapodiidae, and arrange by EDGE score.
b.full <- read.csv("birds_edge_trait.csv", header = TRUE)
b <- b.full[b.full$Family == "MEGAPODIIDAE", c(2,5:7)]

# Aggregate by species and average across trait measurements.
b.agg <- dplyr::arrange(
  dplyr::summarise(
    group_by(b, Species, Common.name, EDGE),
    .groups = "keep",
    avg.HWI = mean(Hand.wing.Index)),
  desc(EDGE))

# Output results
b.agg
```

The malleefowl has a high EDGE score (although not the highest!) and there may be some relationship between HWI and EDGE score.  It seems like species with higher HWI might have  higher EDGE scores.

To evaluate, a linear model of HWI on EDGE score was fit.

```{r stats_model}
# Fit linear model
m.b <- lm(EDGE ~ avg.HWI, data = b.agg)

# Summarise
summary(m.b)
```

The model shows that HWI is not a statistically significant predictor vs an alpha of 5%.  The p-value is very high at .46.

But, is this a good model?  R-squared is 7%, showing that the model explains only a very small percentage of the variance in the data. Is linear regression even appropriate in this case?

```{r stats_plot}
# Plot linear model
par(mfrow = c(2,2))
plot(m.b)

# Plot histogram of residuals
hist(m.b$residuals)
```

It's difficult to tell because degrees of freedom are low.  But, there seem to be two issues.

Examining the plot of residuals vs fitted values shows significant heteroskedasticity.  Variance is much higher on the low end of the distribution than on the high end.  This will result HWI being a biased estimator.

Examining the Q-Q plot of z-transformed residuals vs theoretical quantiles of the z distribution, the residuals don't look normally distributed.  If they were normal, they would align along the straight line.  Instead, they curve off it at the high and low ends of the distribution.  Looking at a histogram of residuals confirms it, they have a strong right skew.

In fact, there is a worse problem:  the data clearly aren't independent!  These aren't random observations from a pool of hypothetical Megapodiidae species.  They're evoluationarily related species. 

## Summary


## Citations

Benshemesh, J. (2007). National Recovery Plan for Malleefowl. Department for Environment and Heritage, South Australia

(Blakers et al. 1984)

Priddel & Wheeler 2003

Copley & Williams 1995)

Hill 1989

Brickhill 1987b  #unseasonable weather hurting egg incubation